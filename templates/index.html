<!DOCTYPE html>
<html>

<head>
    <title>Books Search</title>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/styles.css">
</head>

<body>
    <h1>Book Search</h1>
    <div class="container" id="main">
        <div class="left-column">
            <h2>Searched Books</h2>
            <table id="books-table" class="books-table"></table>
        </div>
        <div class="right-column">
            <h2 id="labels-heading">Search</h2>

            <!-- Search form -->
            <form id="search-form" method="get">
                <input type="text" id="search-input" name="q" placeholder="Enter book subject(s)" size="70">
                <button type="submit" id="search-btn" class="btn btn-primary" disabled>Search</button>
            </form>
            <!-- Button to proceed to next book -->
            <button type="button" id="proceed-btn" class="btn btn-danger" data-target="#proceed-modal">
                Proceed to next book!
            </button>

            <!-- Book proceeding Modal -->
            <div class="modal fade" id="proceed-modal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form id="proceed-form"
                            action="{{ url_for('proceed_fn') }}"
                            method="post" autocomplete="off">
                            <div class="modal-header">
                                <h4 class="modal-title">What book was not found?</h4>
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                            </div>
                            <div class="modal-body">
                                <label for="title">Book Title:</label>
                                <input type="text" id="title" name="title" class="form-control">
                                <label for="authors">Book Author(s):</label>
                                <input type="text" id="authors" name="authors" class="form-control">
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-primary">Confirm not-found</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-6">
                        <h3>Labels A</h2>
                            <div class="results" id="results-a">
                                <!-- Search results will be displayed here -->
                            </div>
                            <div class="results-book-found" id="results-book-found-a">
                                Book found in here!
                            </div>
                    </div>
                    <div class="col-6">
                        <h3>Labels B</h2>
                            <div class="results" id="results-b">
                                <!-- Search results will be displayed here -->
                            </div>
                            <div class="results-book-found" id="results-book-found-b">
                                Book found in here!
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="/static/table.js"></script>

    <script>
        var isBookFoundA = false;
        var isBookFoundB = false;
        var searchCount = 0;
        var searchCountA;
        var searchCountB;
        var searchTermsA;
        var searchTermsB;
        var foundTimeA;
        var foundTimeB;
        var searchBeginTime;
        var selectedTitle;
        var selectedAuthors;

        $('#search-form').on('submit', async function (event) {
            event.preventDefault();

            const query = $('input[name="q"]').val();
            await searchLabels(query, 'a');  // TODO Skip searching, if already found from labels A or B
            await searchLabels(query, 'b');
            searchCount++;

            // Attach event listeners to the "Select" buttons
            await $('.select-btn').on('click', async function () {
                selectedTitleNew = $(this).data('title');
                selectedAuthorsNew = $(this).data('authors');
                if (typeof selectedTitle !== 'undefined' && selectedTitleNew != selectedTitle) {
                    alert('Different selections!')
                }

                const labels_set = $(this).data('labels_set');
                selectedTitle = $(this).data('title');
                selectedAuthors = $(this).data('authors');

                switch (labels_set) {
                    case 'a':
                        isBookFoundA = true;
                        foundTimeA = new Date().toISOString();
                        searchCountA = searchCount;
                        searchTermsA = query;
                        break;
                    case 'b':
                        isBookFoundB = true;
                        foundTimeB = new Date().toISOString();
                        searchCountB = searchCount;
                        searchTermsB = query;
                        break;
                }

                // Indicate that book is now found for these labels
                $('#results-' + labels_set).hide();
                $('#results-book-found-' + labels_set).show();

                if (isBookFoundA && isBookFoundB) {
                    // No need to search anymore, disable search button
                    $("#search-btn").prop('disabled', true);
                }
            });
        });

        $('#proceed-modal').on('shown.bs.modal', function () {
            $('#title').focus();
        })

        // The form is needed when the book is not known, i.e. found neither in labels A or B
        $('#proceed-form').on('submit', async function (event) {
            event.preventDefault();
            const title = $('input[name="title"]').val();
            const authors = $('input[name="authors"]').val();
            submitBook(title, authors, false, false);
            $('#proceed-modal').modal('hide');
        });

        async function submitBook(title, authors, isBookFoundA, isBookFoundB) {
            const formData = new FormData();
            formData.append('title', title);
            formData.append('authors', authors);
            formData.append('isBookFoundA', isBookFoundA);
            formData.append('isBookFoundB', isBookFoundB);

            formData.append('searchCountA', searchCountA);
            formData.append('searchCountB', searchCountB);

            formData.append('searchTermsA', searchTermsA);
            formData.append('searchTermsB', searchTermsB);

            const searchEndTime = new Date().toISOString();
            formData.append('searchBeginTimeUtc', searchBeginTime)
            formData.append('searchEndTimeUtc', searchEndTime);
            formData.append('foundTimeA', foundTimeA);
            formData.append('foundTimeB', foundTimeB);

            await fetch("{{ url_for('proceed_fn') }}", {
                method: 'POST',
                body: formData
            }).then(response => {
                // Handle response as needed
            }).catch(error => {
                console.error('Error proceeding result:', error);
            });

            // Clear search results
            $('.results').empty();
            // Clear the search input field
            $('#search-input').val('');
            // Clear the modal input fields
            $('#title').val('');
            $('#authors').val('');
            // Disable search button
            $("#search-btn").prop('disabled', true);
            // Again show A &B results for upcoming searches
            $('.results').show();
            $('.results-book-found').hide();

            searchBeginTime = undefined;  // Why this needs to be here instead of in listener?
            await generateBooksTable();
        }

        async function searchLabels(query, labels_set) {
            const response = await fetch(`/search/${labels_set}?q=${query}`);
            const data = await response.json();
            const resultsDiv = $('#results-' + labels_set);
            const totalCount = data.results_count;
            resultsDiv.empty();

            // Display the total number of results
            const coverImageUrlBase = "https://www.finna.fi/Cover/Show?source=Solr&invisbn=";
            const totalCountDiv = $('<h4>').addClass('total-count').text(`Number of Results: ${totalCount}`);
            resultsDiv.append(totalCountDiv);

            if (data.results) {
                data.results.forEach(result => {
                    const resultDiv = $('<div>').addClass('result');
                    resultDiv.html(`
                        <img src="${coverImageUrlBase}${result.isbn}" alt="Cover Image" class="book-cover">
                        <div class="result-details">
                            <p><strong>Title:</strong> ${result.title}</p>
                            <p><strong>Author(s):</strong> ${result.authors}</p>
                            <p><strong>Year:</strong> ${result.year}</p>
                            <p><strong>ISBN:</strong> ${result.isbn}</p>
                            <button class="select-btn btn btn-success" data-labels_set="${labels_set}" data-title="${result.title}" data-authors="${result.authors}" data-year="${result.year}" data-isbn="${result.isbn}">Select</button>
                        </div>
                    `);
                    resultsDiv.append(resultDiv);
                });
            } else {
                resultsDiv.html('<p>No results found.</p>');
            }
        }

        function split(val) {
            return val.split(/,\s*/);
        }

        // Function to extract the current term being typed
        function extractLast(term) {
            return split(term).pop();
        }

        $(document).ready(function () {
            // Fetch and display selected books when the page loads
            generateBooksTable();
            $('.results-book-found').hide();

            $('#search-input')
                .on('input', function () {
                    $("#search-btn").prop('disabled', true);
                    // Capture the initial input timestamp when the user starts typing
                    if (!searchBeginTime) {
                        searchBeginTime = new Date().toISOString();
                    }
                })
                .autocomplete({
                    minLength: 3,  // Set the minimum length required to trigger autocomplete
                    source: function (request, response) {
                        const term = extractLast(request.term);

                        if (request.term.length >= 3) {
                            $.ajax({
                                url: "/autocomplete",
                                data: { q: term },
                                dataType: "json",
                                success: function (data) {
                                    response(data);
                                }
                            });
                        } else {
                            // Clear autocomplete suggestions if input is less than 3 characters
                            response([]);
                        }
                    },
                    focus: function () {
                        // prevent value inserted on focus
                        return false;
                    },
                    select: function (event, ui) {
                        var terms = split(this.value);
                        // remove the current input
                        terms.pop();
                        // add the selected item
                        terms.push(ui.item.value);
                        // add placeholder to get the comma-and-space at the end
                        terms.push("");
                        this.value = terms.join(", ");
                        $("#search-btn").prop('disabled', false);
                        return false;
                    },
                });

            $('#proceed-btn').click(function() {
                if (isBookFoundA || isBookFoundB) {
                    // Book already known
                    submitBook(selectedTitle, selectedAuthors, isBookFoundA, isBookFoundB);
                } else {
                    // Book not known, user needs to enter title and authors
                    $('#proceed-modal').modal('show');
                }

                isBookFoundA = false;
                isBookFoundB = false;
                searchCount = 0;
                searchCountA = undefined;
                searchCountB = undefined;
                searchTermsA = undefined;
                searchTermsB = undefined;
                foundTimeA = undefined;
                foundTimeB = undefined;
                selectedAuthors = undefined;
                selectedTitle = undefined;
            });

        });

    </script>
</body>

</html>